<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Typing Game</title>
    <!-- Toastify CSS -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css"
    />
    <style>
      body {
        font-family: monospace;
        background-color: #f0f0f0;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      .container {
        background: white;
        border: 2px solid #333;
        border-radius: 10px;
        padding: 30px;
        max-width: 900px;
        width: 100%;
        text-align: center;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      h1 {
        margin-bottom: 20px;
        color: #333;
      }

      .nav-buttons {
        margin-bottom: 30px;
      }

      .nav-button {
        font-size: 16px;
        padding: 10px 20px;
        border: 2px solid #333;
        border-radius: 5px;
        background: white;
        cursor: pointer;
        margin: 0 10px;
      }

      .nav-button:hover {
        background: #f0f0f0;
      }

      .nav-button.active {
        background: #333;
        color: white;
      }

      .stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 30px;
        padding: 15px;
        background: #f8f8f8;
        border-radius: 5px;
      }

      .stat-item {
        text-align: center;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #333;
      }

      .stat-label {
        font-size: 12px;
        color: #666;
      }

      .combo-display {
        background: #f8f8f8;
        border: 2px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 20px;
        font-size: 18px;
        font-weight: bold;
        color: #333;
      }

      .problem-info {
        background: #e8f4fd;
        border: 1px solid #bee5eb;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: left;
        font-size: 14px;
        color: #0c5460;
      }

      .problem-title {
        font-weight: bold;
        margin-bottom: 5px;
      }

      .word-display {
        font-size: 18px;
        font-weight: bold;
        margin: 30px 0;
        min-height: 200px;
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
        background: #f8f8f8;
        border-radius: 5px;
        padding: 30px;
        white-space: pre-wrap;
        text-align: left;
        overflow-wrap: break-word;
        border: 2px solid #ddd;
      }

      .correct {
        color: green;
        background-color: #e8f5e8;
      }

      .current {
        color: blue;
        background-color: #e8f0ff;
        animation: blink 1s infinite;
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0.3;
        }
      }

      input,
      textarea {
        font-size: 16px;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-family: monospace;
      }

      input {
        width: 80%;
        text-align: left;
      }

      input:focus,
      textarea:focus {
        outline: none;
        border-color: #333;
      }

      textarea {
        width: 90%;
        height: 200px;
        resize: vertical;
      }

      .form-group {
        margin-bottom: 20px;
        text-align: left;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }

      button {
        font-size: 16px;
        padding: 10px 20px;
        border: 2px solid #333;
        border-radius: 5px;
        background: white;
        cursor: pointer;
        margin: 5px;
      }

      button:hover {
        background: #f0f0f0;
      }

      button:disabled {
        background: #ddd;
        cursor: not-allowed;
      }

      .score-display {
        background: #f8f8f8;
        border: 2px solid #ddd;
        border-radius: 10px;
        padding: 30px;
        margin: 30px 0;
      }

      .score-title {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 20px;
        color: #333;
      }

      .score-stats {
        display: flex;
        justify-content: space-around;
        margin: 20px 0;
      }

      .score-item {
        text-align: center;
      }

      .score-value {
        font-size: 28px;
        font-weight: bold;
        color: #333;
      }

      .score-label {
        font-size: 14px;
        color: #666;
      }

      .repeat-message {
        font-size: 18px;
        margin: 20px 0;
        color: #333;
      }

      .alert {
        padding: 15px;
        margin: 20px 0;
        border-radius: 5px;
      }

      .alert-success {
        background: #f8f8f8;
        border: 1px solid #ddd;
        color: #333;
      }

      .alert-warning {
        background: #f8f8f8;
        border: 1px solid #ddd;
        color: #333;
      }

      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #333;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 1000;
        transform: translateX(400px);
        transition: transform 0.3s ease;
        font-size: 14px;
        max-width: 300px;
      }

      .toast.show {
        transform: translateX(0);
      }

      .confetti {
        position: fixed;
        width: 10px;
        height: 10px;
        background: #666;
        animation: confetti-fall 3s linear infinite;
        z-index: 999;
      }

      .confetti:nth-child(2n) {
        background: #777;
      }
      .confetti:nth-child(3n) {
        background: #888;
      }
      .confetti:nth-child(4n) {
        background: #999;
      }
      .confetti:nth-child(5n) {
        background: #aaa;
      }
      .confetti:nth-child(6n) {
        background: #bbb;
      }

      @keyframes confetti-fall {
        to {
          transform: translateY(100vh) rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Typing Game</h1>

      <div class="nav-buttons">
        <button class="nav-button active" onclick="showPage('game')">
          ã‚²ãƒ¼ãƒ 
        </button>
        <button class="nav-button" onclick="showPage('manage')">
          å•é¡Œç®¡ç†
        </button>
      </div>

      <!-- ã‚²ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ -->
      <div id="gamePage" class="page active">
        <div class="stats">
          <div class="stat-item">
            <div class="stat-value" id="wpm">0</div>
            <div class="stat-label">WPM</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="accuracy">100%</div>
            <div class="stat-label">Accuracy</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="progress">0/0</div>
            <div class="stat-label">Progress</div>
          </div>
        </div>

        <div class="combo-display" id="comboDisplay">ğŸ”¥ 0 COMBO</div>

        <div class="problem-info" id="problemInfo" style="display: none">
          <div class="problem-title" id="problemTitle">Problem:</div>
          <div id="problemDesc">Description will appear here</div>
        </div>

        <div class="word-display">
          <div class="word" id="word">
            å•é¡Œã‚’ç™»éŒ²ã—ã¦ã‹ã‚‰SPACEã‚’æŠ¼ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ
          </div>
        </div>

        <div id="gameControls">
          <button id="startBtn" onclick="startGame()">
            Start (or press SPACE)
          </button>
        </div>

        <!-- ã‚¹ã‚³ã‚¢è¡¨ç¤º -->
        <div class="score-display" id="scoreDisplay" style="display: none">
          <div class="score-title">ğŸ‰ å•é¡Œå®Œäº†ï¼</div>
          <div class="score-stats">
            <div class="score-item">
              <div class="score-value" id="scoreWpm">0</div>
              <div class="score-label">WPM</div>
            </div>
            <div class="score-item">
              <div class="score-value" id="scoreAccuracy">0%</div>
              <div class="score-label">æ­£ç¢ºæ€§</div>
            </div>
            <div class="score-item">
              <div class="score-value" id="scoreCombo">0</div>
              <div class="score-label">æœ€å¤§ã‚³ãƒ³ãƒœ</div>
            </div>
            <div class="score-item">
              <div class="score-value" id="scoreTime">0s</div>
              <div class="score-label">å®Œäº†æ™‚é–“</div>
            </div>
          </div>
          <div class="repeat-message">
            <strong>ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹å ´åˆã¯ SPACEã‚­ãƒ¼ ã‚’æŠ¼ã—ã¦ãã ã•ã„</strong>
          </div>
        </div>
      </div>

      <!-- å•é¡Œç®¡ç†ãƒšãƒ¼ã‚¸ -->
      <div id="managePage" class="page">
        <h2>å•é¡Œç®¡ç†</h2>

        <div class="form-group">
          <label for="problemTitleInput">å•é¡Œã‚¿ã‚¤ãƒˆãƒ«:</label>
          <input
            type="text"
            id="problemTitleInput"
            placeholder="ä¾‹: SELECTæ–‡ã®åŸºæœ¬"
          />
        </div>

        <div class="form-group">
          <label for="problemDescInput">å•é¡Œèª¬æ˜:</label>
          <input
            type="text"
            id="problemDescInput"
            placeholder="ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹"
          />
        </div>

        <div class="form-group">
          <label for="problemTextInput">SQLã‚³ãƒ¼ãƒ‰:</label>
          <textarea
            id="problemTextInput"
            placeholder="ä¾‹:&#10;select *&#10;from users&#10;where active = 1;"
          ></textarea>
        </div>

        <button onclick="saveProblem()">å•é¡Œã‚’ä¿å­˜</button>
        <button onclick="clearProblem()">å•é¡Œã‚’ã‚¯ãƒªã‚¢</button>

        <div id="saveMessage"></div>

        <div id="currentProblem" style="margin-top: 30px">
          <h3>ç¾åœ¨ã®å•é¡Œ</h3>
          <div id="currentProblemDisplay">å•é¡ŒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
        </div>
      </div>
    </div>

    <script>
      let currentProblem = null;
      let currentIndex = 0;
      let correctChars = 0;
      let totalChars = 0;
      let startTime = 0;
      let isGameActive = false;
      let combo = 0;
      let maxCombo = 0;
      let correctStreak = 0;
      let lastToastTime = 0;

      // ã‚³ãƒ³ãƒœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      const comboMessages = [
        "ğŸ”¥ NICE COMBO!",
        "âš¡ AMAZING STREAK!",
        "ğŸš€ ON FIRE!",
        "ğŸ’¯ UNSTOPPABLE!",
        "ğŸŒŸ LEGENDARY!",
        "ğŸ’¥ INCREDIBLE!",
        "ğŸ¯ PERFECT!",
        "â­ GODLIKE!",
      ];

      const wordDisplay = document.getElementById("word");
      const wpmDisplay = document.getElementById("wpm");
      const accuracyDisplay = document.getElementById("accuracy");
      const progressDisplay = document.getElementById("progress");
      const comboDisplay = document.getElementById("comboDisplay");
      const scoreDisplay = document.getElementById("scoreDisplay");
      const startBtn = document.getElementById("startBtn");
      const problemInfo = document.getElementById("problemInfo");
      const problemTitle = document.getElementById("problemTitle");
      const problemDesc = document.getElementById("problemDesc");

      function showPage(pageId) {
        document
          .querySelectorAll(".page")
          .forEach((page) => page.classList.remove("active"));
        document
          .querySelectorAll(".nav-button")
          .forEach((btn) => btn.classList.remove("active"));

        document.getElementById(pageId + "Page").classList.add("active");
        event.target.classList.add("active");

        if (pageId === "manage") {
          loadCurrentProblem();
          loadProblemToForm(); // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜å•é¡Œã‚’èª­ã¿è¾¼ã¿
        }
      }

      function loadProblemToForm() {
        const saved = localStorage.getItem("sqlTypingProblem");
        if (saved) {
          const problem = JSON.parse(saved);
          document.getElementById("problemTitleInput").value = problem.title;
          document.getElementById("problemDescInput").value = problem.desc;
          document.getElementById("problemTextInput").value = problem.text;
        }
      }

      function saveProblem() {
        const title = document.getElementById("problemTitleInput").value.trim();
        const desc = document.getElementById("problemDescInput").value.trim();
        const text = document.getElementById("problemTextInput").value.trim();

        if (!title || !desc || !text) {
          showMessage("ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "warning");
          return;
        }

        const problem = { title, desc, text };
        localStorage.setItem("sqlTypingProblem", JSON.stringify(problem));
        showMessage("å•é¡Œã‚’ä¿å­˜ã—ã¾ã—ãŸï¼", "success");
        loadCurrentProblem();

        // å•é¡Œä¿å­˜å¾Œã€ã‚²ãƒ¼ãƒ ç”»é¢ã«è‡ªå‹•é·ç§»
        setTimeout(() => {
          showPage("game");
          document.querySelector(".nav-button").classList.add("active");
          document
            .querySelectorAll(".nav-button")[1]
            .classList.remove("active");
        }, 1000);
      }

      function clearProblem() {
        if (confirm("å•é¡Œã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
          localStorage.removeItem("sqlTypingProblem");
          document.getElementById("problemTitleInput").value = "";
          document.getElementById("problemDescInput").value = "";
          document.getElementById("problemTextInput").value = "";
          showMessage("å•é¡Œã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ", "success");
          loadCurrentProblem();
        }
      }

      function loadCurrentProblem() {
        const saved = localStorage.getItem("sqlTypingProblem");
        if (saved) {
          const problem = JSON.parse(saved);
          document.getElementById(
            "currentProblemDisplay"
          ).innerHTML = `<strong>${problem.title}</strong><br>${problem.desc}<br><pre>${problem.text}</pre>`;
        } else {
          document.getElementById("currentProblemDisplay").textContent =
            "å•é¡ŒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“";
        }
      }

      function showMessage(message, type) {
        const messageDiv = document.getElementById("saveMessage");
        messageDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => (messageDiv.innerHTML = ""), 3000);
      }

      function showToast(message, duration = 2000) {
        const currentTime = Date.now();
        if (currentTime - lastToastTime < 500) return;
        lastToastTime = currentTime;

        // ToastifyãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ä½¿ç”¨ã€ãã†ã§ãªã‘ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if (typeof Toastify !== "undefined") {
          Toastify({
            text: message,
            duration: duration,
            gravity: "top",
            position: "right",
            style: {
              background: "#333",
              color: "#fff",
              fontSize: "14px",
              borderRadius: "8px",
            },
          }).showToast();
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚·ãƒ³ãƒ—ãƒ«ãªã‚¢ãƒ©ãƒ¼ãƒˆ
          alert(message);
        }
      }

      function updateCombo() {
        if (correctStreak > 0 && correctStreak % 5 === 0) {
          combo++;
          maxCombo = Math.max(maxCombo, combo);
          const message =
            comboMessages[Math.min(combo - 1, comboMessages.length - 1)];
          showToast(`${combo} COMBO! ${message}`, 2500);

          if (combo % 5 === 0) {
            createConfetti();
            showToast(`ğŸ‰ ${combo} COMBO CELEBRATION! ğŸ‰`, 3000);
          }
        }

        comboDisplay.textContent = `ğŸ”¥ ${combo} COMBO`;
      }

      function startGame() {
        const saved = localStorage.getItem("sqlTypingProblem");
        if (!saved) {
          showToast("å…ˆã«å•é¡Œã‚’ç™»éŒ²ã—ã¦ãã ã•ã„", 3000);
          return;
        }

        // ç”»é¢ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        window.scrollTo({ top: 0, behavior: "smooth" });

        currentProblem = JSON.parse(saved);
        isGameActive = true;
        currentIndex = 0;
        correctChars = 0;
        totalChars = 0;
        combo = 0;
        maxCombo = 0;
        correctStreak = 0;
        startTime = Date.now();

        problemTitle.textContent = currentProblem.title;
        problemDesc.textContent = currentProblem.desc;
        problemInfo.style.display = "block";

        displayWord();

        startBtn.textContent = "ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ä¸­...";
        startBtn.disabled = true;

        scoreDisplay.style.display = "none";
        updateCombo();
        updateStats();

        showToast("ğŸ® ã‚²ãƒ¼ãƒ é–‹å§‹ï¼", 2000);
      }

      function endGame() {
        isGameActive = false;
        startBtn.textContent = "Start (or press SPACE)";
        startBtn.disabled = false;

        const completionTime = Math.round((Date.now() - startTime) / 1000);
        const wpm = Math.round(
          currentProblem.text.length / 5 / (completionTime / 60)
        );
        const accuracy =
          totalChars > 0 ? Math.round((correctChars / totalChars) * 100) : 100;

        document.getElementById("scoreWpm").textContent = wpm;
        document.getElementById("scoreAccuracy").textContent = accuracy + "%";
        document.getElementById("scoreCombo").textContent = maxCombo;
        document.getElementById("scoreTime").textContent = completionTime + "s";

        scoreDisplay.style.display = "block";

        // ã‚¹ã‚³ã‚¢è¡¨ç¤ºä½ç½®ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        setTimeout(() => {
          scoreDisplay.scrollIntoView({ behavior: "smooth", block: "center" });
        }, 100);

        if (maxCombo >= 20) {
          showToast("ğŸ† SQL MASTER! Ultimate combo!", 4000);
        } else if (maxCombo >= 10) {
          showToast("ğŸ”¥ EXCELLENT! Double digit combo!", 3000);
        } else if (maxCombo >= 5) {
          showToast("âš¡ GREAT JOB! Nice combo streak!", 3000);
        }
      }

      function displayWord() {
        if (!currentProblem) return;

        let html = "";
        for (let i = 0; i < currentProblem.text.length; i++) {
          const char = currentProblem.text[i];
          let displayChar = char;

          if (char === "\n") {
            displayChar = "â†µ<br>";
          } else if (char === " ") {
            displayChar = "&nbsp;"; // é€šå¸¸ã®ã‚¹ãƒšãƒ¼ã‚¹ã¨ã—ã¦è¡¨ç¤º
          }

          if (i < currentIndex) {
            html += '<span class="correct">' + displayChar + "</span>";
          } else if (i === currentIndex) {
            html += '<span class="current">' + displayChar + "</span>";
          } else {
            html += "<span>" + displayChar + "</span>";
          }
        }
        wordDisplay.innerHTML = html;
      }

      function updateStats() {
        if (!currentProblem) return;

        const timeElapsed = (Date.now() - startTime) / 1000 / 60;
        const wpm =
          timeElapsed > 0 ? Math.round(currentIndex / 5 / timeElapsed) : 0;
        // æ­£ç­”ç‡è¨ˆç®—ã‚’ä¿®æ­£ï¼šè‡ªå‹•å‡¦ç†ã•ã‚ŒãŸæ–‡å­—ã¯é™¤å¤–
        const accuracy =
          totalChars > 0 ? Math.round((correctChars / totalChars) * 100) : 100;

        wpmDisplay.textContent = wpm;
        accuracyDisplay.textContent = Math.min(accuracy, 100) + "%"; // 100%ä¸Šé™
        progressDisplay.textContent = `${currentIndex}/${currentProblem.text.length}`;
      }

      document.addEventListener("keydown", function (e) {
        // å•é¡Œç®¡ç†ç”»é¢ã§ã¯ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ã‚²ãƒ¼ãƒ é–‹å§‹ã—ãªã„
        if (
          e.key === " " &&
          !isGameActive &&
          document.getElementById("gamePage").classList.contains("active")
        ) {
          e.preventDefault();
          startGame();
        } else if (e.key === "Escape") {
          if (isGameActive) {
            isGameActive = false;
            startBtn.textContent = "Start (or press SPACE)";
            startBtn.disabled = false;
            scoreDisplay.style.display = "none";
          }
        } else if (isGameActive && currentProblem) {
          // ã‚²ãƒ¼ãƒ ä¸­ã®ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
          if (e.key.length === 1) {
            // é€šå¸¸ã®æ–‡å­—ã‚­ãƒ¼ã®ã¿
            e.preventDefault();

            const inputChar = e.key;
            const targetChar = currentProblem.text[currentIndex];
            totalChars++;

            if (inputChar === targetChar) {
              correctChars++;
              correctStreak++;
              currentIndex++;

              // æ”¹è¡Œã®è‡ªå‹•å‡¦ç†ï¼ˆcorrectCharsã¨totalCharsã«ã¯å«ã‚ãªã„ï¼‰
              while (
                currentIndex < currentProblem.text.length &&
                currentProblem.text[currentIndex] === "\n"
              ) {
                currentIndex++;

                // æ”¹è¡Œå¾Œã®è¡Œé ­ã‚¹ãƒšãƒ¼ã‚¹ï¼ˆã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼‰ã‚’è‡ªå‹•å‡¦ç†
                while (
                  currentIndex < currentProblem.text.length &&
                  currentProblem.text[currentIndex] === " "
                ) {
                  currentIndex++;
                }
              }

              updateCombo();

              if (currentIndex >= currentProblem.text.length) {
                endGame();
                return;
              }

              displayWord();
            } else {
              correctStreak = 0;
              combo = 0;
              updateCombo();
            }

            updateStats();
          }
        }
      });

      // åˆæœŸåŒ–
      loadCurrentProblem();
    </script>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
  </body>
</html>
